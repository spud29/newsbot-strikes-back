{% extends "base.html" %}

{% block title %}Database - NewsBot{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-database"></i> Database Tools</h1>
        <p class="text-muted">Manage database and search entries</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" onclick="refreshDatabase()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <button class="btn btn-success" onclick="exportDatabase()">
            <i class="bi bi-download"></i> Export
        </button>
    </div>
</div>

<!-- Database Stats -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Processed IDs</h5>
                <h3 id="stat-processed-ids" class="text-primary">
                    <span class="spinner-border spinner-border-sm"></span>
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Embeddings</h5>
                <h3 id="stat-embeddings" class="text-info">
                    <span class="spinner-border spinner-border-sm"></span>
                </h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Message Mappings</h5>
                <h3 id="stat-mappings" class="text-success">
                    <span class="spinner-border spinner-border-sm"></span>
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- Search & Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-search"></i> Search Entries</h5>
            </div>
            <div class="card-body">
                <form onsubmit="event.preventDefault(); searchDatabase();">
                    <div class="input-group mb-3">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="search-query" 
                            placeholder="Search by entry ID or text content..."
                        >
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </form>
                <p class="text-muted small mb-2">
                    <i class="bi bi-info-circle"></i> 
                    You can search by entry ID (e.g., "telegram_123" or "twitter_456") or by any text in the message content.
                </p>
                
                <div id="search-results"></div>
            </div>
        </div>
    </div>
</div>

<!-- Database Actions -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card border-warning">
            <div class="card-header bg-warning bg-opacity-10">
                <h5 class="mb-0"><i class="bi bi-trash"></i> Cleanup Old Entries</h5>
            </div>
            <div class="card-body">
                <p>Remove entries older than the retention period ({{ config.DB_RETENTION_HOURS }} hours).</p>
                <button class="btn btn-warning" onclick="cleanupDatabase()">
                    <i class="bi bi-trash"></i> Run Cleanup
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card border-danger">
            <div class="card-header bg-danger bg-opacity-10">
                <h5 class="mb-0"><i class="bi bi-arrow-counterclockwise"></i> Reset Entry</h5>
            </div>
            <div class="card-body">
                <p>Remove a specific entry to allow reprocessing.</p>
                <form onsubmit="event.preventDefault(); resetEntry();">
                    <div class="input-group">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="reset-entry-id" 
                            placeholder="Entry ID..."
                        >
                        <button class="btn btn-danger" type="submit">
                            <i class="bi bi-arrow-counterclockwise"></i> Reset
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
async function refreshDatabase() {
    try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        
        document.getElementById('stat-processed-ids').textContent = data.database.processed_ids;
        document.getElementById('stat-embeddings').textContent = data.database.embeddings;
        document.getElementById('stat-mappings').textContent = data.database.message_mappings;
    } catch (error) {
        console.error('Error refreshing database:', error);
        alert('Failed to refresh database statistics');
    }
}

async function searchDatabase() {
    const query = document.getElementById('search-query').value;
    const resultsDiv = document.getElementById('search-results');
    
    if (!query) {
        resultsDiv.innerHTML = '';
        return;
    }
    
    resultsDiv.innerHTML = '<div class="text-center"><span class="spinner-border"></span></div>';
    
    try {
        const response = await fetch(`/api/database/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.found) {
            let html = `<div class="alert alert-success">
                <h6>Found ${data.count} result${data.count > 1 ? 's' : ''}</h6>
            </div>`;
            
            // Display each result
            data.results.forEach((result, index) => {
                const matchTypeLabels = {
                    'exact_id': 'Exact ID Match',
                    'partial_id': 'Partial ID Match',
                    'content': 'Content Match',
                    'embedding_preview': 'Embedding Preview Match'
                };
                
                const matchTypeBadges = {
                    'exact_id': 'success',
                    'partial_id': 'info',
                    'content': 'primary',
                    'embedding_preview': 'secondary'
                };
                
                html += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <span class="badge bg-${matchTypeBadges[result.match_type]} me-2">
                                        ${matchTypeLabels[result.match_type]}
                                    </span>
                                    <code class="text-break">${result.entry_id}</code>
                                </div>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary" 
                                            onclick="toggleEntryDetails('${result.entry_id}', ${index})"
                                            id="details-btn-${index}"
                                            title="View full details and media">
                                        <i class="bi bi-eye"></i> Details
                                    </button>
                                    <button class="btn btn-outline-success" 
                                            onclick="reprocessEntryFromSearch('${result.entry_id}')"
                                            title="Reprocess and post to Discord again">
                                        <i class="bi bi-arrow-repeat"></i> Reprocess
                                    </button>
                                    <button class="btn btn-outline-danger" 
                                            onclick="fillResetField('${result.entry_id}')"
                                            title="Reset this entry">
                                        <i class="bi bi-arrow-counterclockwise"></i> Reset
                                    </button>
                                </div>
                            </div>
                            <p class="mb-1 text-muted small">
                                <strong>Processed:</strong> ${new Date(result.timestamp * 1000).toLocaleString()}
                            </p>
                            ${result.source_url ? `
                                <p class="mb-1 small">
                                    <strong>Source URL:</strong> 
                                    <a href="${result.source_url}" target="_blank" rel="noopener noreferrer">
                                        ${result.source_url}
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                </p>
                            ` : ''}
                            ${result.preview ? `
                                <div class="mt-2 p-2 bg-light rounded">
                                    <small class="text-muted">Preview:</small><br>
                                    <small>${result.preview}</small>
                                </div>
                            ` : ''}
                            <div id="entry-details-${index}" class="mt-3" style="display: none;">
                                <div class="text-center py-3">
                                    <span class="spinner-border spinner-border-sm"></span>
                                    <span class="ms-2">Loading details...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = '<div class="alert alert-info">No entries found matching your search</div>';
        }
    } catch (error) {
        console.error('Error searching database:', error);
        resultsDiv.innerHTML = '<div class="alert alert-danger">Search failed</div>';
    }
}

function fillResetField(entryId) {
    document.getElementById('reset-entry-id').value = entryId;
    // Scroll to reset section
    document.getElementById('reset-entry-id').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

async function cleanupDatabase() {
    if (!confirm('Are you sure you want to cleanup old entries?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/database/clear', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            alert('Database cleanup completed successfully');
            refreshDatabase();
        } else {
            alert('Cleanup failed: ' + result.error);
        }
    } catch (error) {
        console.error('Error cleaning database:', error);
        alert('Failed to cleanup database');
    }
}

async function resetEntry() {
    const entryId = document.getElementById('reset-entry-id').value;
    
    if (!entryId) {
        alert('Please enter an entry ID');
        return;
    }
    
    if (!confirm(`Are you sure you want to reset entry: ${entryId}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/database/reset/${encodeURIComponent(entryId)}`, { 
            method: 'DELETE' 
        });
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            document.getElementById('reset-entry-id').value = '';
            refreshDatabase();
        } else {
            alert('Reset failed: ' + result.error);
        }
    } catch (error) {
        console.error('Error resetting entry:', error);
        alert('Failed to reset entry');
    }
}

async function reprocessEntryFromSearch(entryId) {
    if (!confirm(`Are you sure you want to reprocess and repost this entry?\n\nEntry: ${entryId}\n\nThis will:\n- Extract the content from the database\n- Categorize it again\n- Post it to Discord again\n- Create a new entry ID`)) {
        return;
    }
    
    // Show loading state
    const resultsDiv = document.getElementById('search-results');
    const originalHTML = resultsDiv.innerHTML;
    
    try {
        resultsDiv.innerHTML = '<div class="text-center my-4"><span class="spinner-border"></span><p class="mt-2">Reprocessing entry...</p></div>';
        
        const response = await fetch(`/api/database/reprocess/${encodeURIComponent(entryId)}`, { 
            method: 'POST' 
        });
        const result = await response.json();
        
        if (result.success) {
            let message = `✅ Entry successfully reprocessed!\n\n`;
            message += `Category: ${result.category}\n`;
            message += `Discord Message ID: ${result.discord_message_id}\n`;
            message += `New Entry ID: ${result.new_entry_id}\n`;
            if (result.duplicate_warning) {
                message += `\n⚠️ ${result.duplicate_warning}`;
            }
            alert(message);
            refreshDatabase();
            // Restore search results
            resultsDiv.innerHTML = originalHTML;
        } else {
            alert('❌ Reprocess failed:\n\n' + result.error);
            resultsDiv.innerHTML = originalHTML;
        }
    } catch (error) {
        console.error('Error reprocessing entry:', error);
        alert('Failed to reprocess entry: ' + error.message);
        resultsDiv.innerHTML = originalHTML;
    }
}

async function exportDatabase() {
    try {
        const response = await fetch('/api/database/export');
        const data = await response.json();
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `newsbot-database-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Error exporting database:', error);
        alert('Failed to export database');
    }
}

async function toggleEntryDetails(entryId, index) {
    const detailsDiv = document.getElementById(`entry-details-${index}`);
    const detailsBtn = document.getElementById(`details-btn-${index}`);
    
    // If already visible, just hide it
    if (detailsDiv.style.display === 'block') {
        detailsDiv.style.display = 'none';
        detailsBtn.innerHTML = '<i class="bi bi-eye"></i> Details';
        return;
    }
    
    // Show the details div
    detailsDiv.style.display = 'block';
    detailsBtn.innerHTML = '<i class="bi bi-eye-slash"></i> Hide';
    
    // Check if we've already loaded the details (has more than just the spinner)
    if (detailsDiv.dataset.loaded === 'true') {
        return;
    }
    
    try {
        const response = await fetch(`/api/entry/${encodeURIComponent(entryId)}`);
        const data = await response.json();
        
        if (data.found) {
            detailsDiv.dataset.loaded = 'true';
            detailsDiv.innerHTML = renderEntryDetails(data);
        } else {
            detailsDiv.innerHTML = '<div class="alert alert-warning">Entry details not found</div>';
        }
    } catch (error) {
        console.error('Error fetching entry details:', error);
        detailsDiv.innerHTML = '<div class="alert alert-danger">Failed to load entry details</div>';
    }
}

function renderEntryDetails(data) {
    let html = '<hr>';
    
    // Full content
    if (data.content) {
        html += '<div class="mb-3">';
        html += '<strong>Full Content:</strong>';
        html += '<div class="mt-2 p-3 bg-light rounded" style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; max-height: 300px; overflow-y: auto;">';
        html += escapeHtml(data.content);
        html += '</div>';
        html += '</div>';
    }
    
    // Images
    if (data.media && data.media.images && data.media.images.length > 0) {
        html += '<div class="mb-3">';
        html += '<strong>Images:</strong>';
        html += '<div class="row g-2 mt-2">';
        data.media.images.forEach((imageUrl, index) => {
            html += `<div class="col-md-6">`;
            html += `<div class="card">`;
            html += `<img src="${imageUrl}" class="card-img-top" style="max-height: 300px; width: 100%; object-fit: contain; background-color: #f8f9fa; cursor: pointer;" alt="Image ${index + 1}" onclick="window.open('${imageUrl}', '_blank')" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">`;
            html += `<div style="display: none; padding: 1rem; text-align: center; color: #999;">Image ${index + 1} (failed to load)</div>`;
            html += `<div class="card-body p-2">`;
            html += `<small class="text-muted">Image ${index + 1}</small>`;
            html += `<br><a href="${imageUrl}" target="_blank" rel="noopener noreferrer" class="small">Open in new tab <i class="bi bi-box-arrow-up-right"></i></a>`;
            html += `</div>`;
            html += `</div>`;
            html += `</div>`;
        });
        html += '</div>';
        html += '</div>';
    }
    
    // Videos
    if (data.media && data.media.videos && data.media.videos.length > 0) {
        html += '<div class="mb-3">';
        html += '<strong>Videos:</strong>';
        html += '<div class="row g-2 mt-2">';
        data.media.videos.forEach((videoUrl, index) => {
            html += `<div class="col-md-6">`;
            html += `<div class="card">`;
            
            // Check if it's a URL (external video) or local file
            if (videoUrl.startsWith('http://') || videoUrl.startsWith('https://')) {
                // External video URL (Twitter)
                html += `<div class="card-body">`;
                html += `<p class="mb-2"><strong>Video ${index + 1}</strong></p>`;
                html += `<a href="${videoUrl}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-primary">`;
                html += `<i class="bi bi-play-circle"></i> Open Video`;
                html += `</a>`;
                html += `<br><small class="text-muted mt-2 d-block">External video link</small>`;
                html += `</div>`;
            } else {
                // Local video file (Telegram)
                html += `<video controls class="card-img-top" style="max-height: 400px; width: 100%; background-color: #000;">`;
                html += `<source src="${videoUrl}" type="video/mp4">`;
                html += `Your browser does not support the video tag.`;
                html += `</video>`;
                html += `<div class="card-body p-2">`;
                html += `<small class="text-muted">Video ${index + 1}</small>`;
                html += `<br><a href="${videoUrl}" target="_blank" rel="noopener noreferrer" class="small">Open in new tab <i class="bi bi-box-arrow-up-right"></i></a>`;
                html += `</div>`;
            }
            
            html += `</div>`;
            html += `</div>`;
        });
        html += '</div>';
        html += '</div>';
    }
    
    // If no media at all
    if ((!data.media.images || data.media.images.length === 0) && 
        (!data.media.videos || data.media.videos.length === 0)) {
        html += '<div class="alert alert-info mb-0">';
        html += '<i class="bi bi-info-circle"></i> No media files found for this entry';
        html += '</div>';
    }
    
    return html;
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// Load stats on page load
document.addEventListener('DOMContentLoaded', refreshDatabase);
</script>
{% endblock %}

